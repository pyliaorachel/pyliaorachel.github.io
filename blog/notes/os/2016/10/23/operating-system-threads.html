<!DOCTYPE html>
<html>
	<head>
		<title>Operating System - Threads</title>
		<link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css">
		<link rel="stylesheet" href="/css/main.css" type="text/css">
		<link href="https://fonts.googleapis.com/css?family=Antic+Slab|Catamaran|Hind:300|Inconsolata|Josefin+Sans|Muli:300,400i|Poiret+One|Rajdhani:300|Rock+Salt|Ruda|Scope+One|Shadows+Into+Light|Source+Code+Pro|Space+Mono" rel="stylesheet">
		<link rel="stylesheet" href="/css/github-markdown.css">

		<!-- Place jquery before bootstrap -->
		<script type="text/javascript" src="/js/jquery.min.js"></script>
		<script type="text/javascript" src="/js/bootstrap.min.js"></script>
	</head>
	<body>
		<nav class="navbar navbar-default navbar-fixed-top">
	<div class="container-fluid">

		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">MyCoon</a>
		</div>

		<div class="collapse navbar-collapse" id="navbar-collapse">

			<form class="navbar-form navbar-left">
				<div class="form-group">
					<input type="text" class="form-control" placeholder="Search">
				</div>
				<button type="submit" class="btn btn-default">Submit</button>
			</form>

			<ul class="nav navbar-nav navbar-right" id="nav-links">
				<li class="nav-home"><a href="/">Home</a></li>
				<li class="dropdown nav-blog">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
						Blog<span class="caret"></span>
					</a>
					<ul class="dropdown-menu">
						<li><a href="/blog">MyCoon Blog</a></li>
						<li role="separator" class="divider"></li>
						<li><a href="/blog/categories">Categories</a></li>
						
							
						

						
							
							
							<li class="category">
								<a href="/blog/notes">
									<span>Notes</span>
									<span>7</span>
								</a>
							</li>
						
						<li><a href="/blog/tags">Tags</a></li>
					</ul>
				</li>
				<li class="dropdown nav-tutorial">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
						Tutorials<span class="caret"></span>
					</a>
					<ul class="dropdown-menu">
						<li><a href="/tutorial">MyCoon Tutorial</a></li>
						<li role="separator" class="divider"></li>
						<li><a href="/tutorial/categories">Categories</a></li>
						
							
						

						
						<li><a href="/tutorial/tags">Tags</a></li>
					</ul>
				</li>
				<li  class="nav-project"><a href="/project">Projects</a></li>
				<li class="nav-special" id="special"><a href="#">?</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</div><!-- /.container-fluid -->
</nav>
		<main class="page-content post" aria-label="Content">
	<div class="post-wrapper">
		<div class="wrapper">
	<article class="post-article" itemscope itemtype="http://schema.org/BlogPosting">

		<header class="post-header">
			<h1 class="post-title" itemprop="name headline">Operating System - Threads</h1>
			<p class="post-meta">Oct 23, 2016
				 • Notes
				 • pyliaorachel
			</p>
		</header>

		

		<span class="separator"> • • • </span>

		<div class="post-content" itemprop="articleBody">
			<h2>Content</h2>

<ol>
<li>Threads and Processes</li>
<li>Thread Scheduling</li>
</ol>

<!--more-->

<hr>

<h2>Threads and Processes</h2>

<ul>
<li>When a <strong>program</strong> runs, it is called a <code>process</code></li>
<li>OS maintains states for each abstraction:

<ul>
<li><strong>Thread(CPU) state</strong>

<ul>
<li>Registers, PC, SP, ...</li>
</ul></li>
<li><strong>Address Space (memory) state</strong>

<ul>
<li>Program instructions, static &amp; dynamic data, ...</li>
</ul></li>
<li><strong>Device &amp; other state</strong>

<ul>
<li>Open files, network connection state, ...</li>
</ul></li>
</ul></li>
</ul>

<h3><strong>Threads</strong></h3>

<ul>
<li>Abstraction of <strong>virtualizing CPU</strong>

<ul>
<li>Each <code>thread</code> thinks it has its own set of <code>CPU registers</code></li>
</ul></li>
<li># of <code>threads</code> arbitrary; # of <code>CPUs</code> fixed</li>
<li><p>Enables <strong>concurrency</strong></p>

<ul>
<li>Running multiple programs concurrently</li>
<li>Running multiple tasks concurrently

<ul>
<li>Hiding I/O latency

<ul>
<li>Can use <code>non-blocking file I/O</code> (<code>event-driven</code>), but harder to get right because need to build a state machine</li>
<li>~ <code>interrupts</code></li>
</ul></li>
<li>Run truly in parallel with multiple <code>CPUs</code> via <code>multiplexing</code></li>
</ul></li>
</ul></li>
<li><p><strong>Threads v.s. Functions</strong></p>

<table><thead>
<tr>
<th style="text-align: left">Threads</th>
<th style="text-align: left">Functions</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">Independent streams of execution, one thread no need to run to the end before switching</td>
<td style="text-align: left">LIFO policy, functions runs untill the end</td>
</tr>
<tr>
<td style="text-align: left">Thread scheduler multiplexes the threads on CPU</td>
<td style="text-align: left">One function calls another function</td>
</tr>
<tr>
<td style="text-align: left">Each thread has its own stack, calling its own set of functions</td>
<td style="text-align: left">Running on a single stack</td>
</tr>
<tr>
<td style="text-align: left">Runs in parallel with multiprocessors</td>
<td style="text-align: left">Cannot run in parallel with multiprocessors because functions stack together</td>
</tr>
</tbody></table></li>
</ul>

<h3><strong>Address Space</strong></h3>

<ul>
<li>Abstraction of <strong>virtualizing memory</strong>

<ul>
<li>A set of <em>virtual memory regions</em> accessible to a program

<ul>
<li><code>Text</code>: program code</li>
<li><code>Data</code>, <code>Heap</code>: static, dynamic variables</li>
<li><code>Stack</code>: for function &amp; system calls</li>
</ul></li>
</ul></li>
<li>Provides <strong>memory protection</strong></li>
<li><p>Address space (order may vary with different H/W &amp; compiler environment)</p>
<div class="highlight"><pre><code class="language-" data-lang="">        +++++++++++++++ ----
        |    param    |  |
        +++++++++++++++  |
        |   ret val   |  |
        +++++++++++++++  |
        |   ret addr  |  |  activation frame
        +++++++++++++++  |  for current function
  fp -&gt; |   prev fp   |  |
        +++++++++++++++  |
        |  other regs |  |
        +++++++++++++++  |
  sp -&gt; |  local var  |  |      # function call:
        +++++++++++++++ ----    # push %rbp; save old fp
        |      ↓      |         # mov %rbp %rsp; init sp to fp
        |             |         # retq; call *sp
        |      ↑      |
        +++++++++++++++         # return:
        |    data     |         # add $24 %rsp; pop off stack
        +++++++++++++++         # pop %rbp; fp=*sp (or *fp), sp++
        |    text     |         # retq; call *sp
        +++++++++++++++
</code></pre></div></li>
</ul>

<h3><strong>Processes</strong></h3>

<ul>
<li>A running program consistes of &gt;= 1 processes

<ul>
<li>Traditionally:

<ul>
<li><code>process = addr space + thread</code></li>
<li><code>Threads</code> communicate using <code>system calls</code></li>
</ul></li>
<li>Today:

<ul>
<li><code>process = addr space + &gt;= 1 threads</code></li>
<li><code>Threads</code> share <code>addr space</code> (but not <code>stack</code>)</li>
<li><code>Threads</code> communicate with <code>reading/writing memory</code></li>
</ul></li>
</ul></li>
<li><p>Speed up cases analysis:</p>
<div class="highlight"><pre><code class="language-" data-lang=""># Vector operation
for (k = 0; k &lt; n; k++)
    a[k] = b[k]*c[k] + d[k]*e[k];
</code></pre></div>
<ul>
<li>Multiple processes?

<ul>
<li>Communicate with <code>system call</code>...</li>
</ul></li>
<li>Multiple threads?

<ul>
<li>Must make it global to share data</li>
</ul></li>
<li>On single processor?

<ul>
<li>Threads go one after another</li>
</ul></li>
<li>On multiprocessor?

<ul>
<li>O</li>
</ul></li>
</ul>
<div class="highlight"><pre><code class="language-" data-lang=""># Web server
Loop:
    1. get network message from client -&gt; I/O
    2. get URL data form disk, cache in memory -&gt; I/O
    3. compose response
    4. send response -&gt; I/O
</code></pre></div>
<ul>
<li>Multiple processes?

<ul>
<li>Cannot share the cache (stored in global resource area of that process)</li>
</ul></li>
<li>Multiple threads?

<ul>
<li>O</li>
</ul></li>
<li>On single processor?

<ul>
<li>O</li>
</ul></li>
<li>On multiprocessor?

<ul>
<li>O</li>
</ul></li>
</ul></li>
<li><p><strong>Threads v.s. Processes</strong></p>

<table><thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">Threads</th>
<th style="text-align: left">Processes</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">Memory needed</td>
<td style="text-align: left">Shared, less</td>
<td style="text-align: left">Not shared, more</td>
</tr>
<tr>
<td style="text-align: left">Communication &amp; Synchronization</td>
<td style="text-align: left">Via <strong>shared vars</strong>, faster</td>
<td style="text-align: left">Via <strong>system calls</strong>, slower</td>
</tr>
<tr>
<td style="text-align: left">Switching</td>
<td style="text-align: left">Save &amp; restore regs, faster</td>
<td style="text-align: left">Change MMU&#39;s regs (e.g. base &amp; limit), slower</td>
</tr>
<tr>
<td style="text-align: left">Robustness</td>
<td style="text-align: left">Memory sharing -&gt; bugs</td>
<td style="text-align: left">Communication explicit -&gt; robust</td>
</tr>
</tbody></table></li>
<li><p><strong>Program v.s. Process</strong></p>

<ul>
<li><strong>Program</strong>: a set of instructions &amp; data</li>
<li><strong>Process</strong>: a program loaded in memory and executing</li>
</ul></li>
</ul>

<h3><strong>OS-Level Process State</strong></h3>

<ul>
<li>OS keeps state for each process: <code>process state</code>, <code>process control block (PCB)</code>

<ul>
<li><strong>Thread state</strong>

<ul>
<li><code>Processor regs</code> for resuming/suspending thread</li>
<li><code>Thread id</code></li>
<li>Various <code>parameters</code> e.g. scheduling parameters</li>
</ul></li>
<li><strong>Address space state</strong>

<ul>
<li>Location of <code>text</code>, <code>data</code>, <code>stack</code></li>
<li><code>MMU virtual memory state</code> i.e. virtual -&gt; physical mapping</li>
</ul></li>
<li><strong>Device related state</strong>

<ul>
<li>Open files, network connections</li>
</ul></li>
<li><strong>Other states</strong>

<ul>
<li>Terminal state, pending signals, timers, swap, ...</li>
</ul></li>
</ul></li>
</ul>

<hr>

<h2>Thread Scheduling</h2>

<ul>
<li><code>Thread</code>: an independent stream of instructions

<ul>
<li>Which to choose?</li>
<li>When to switch?</li>
<li>How to switch?</li>
</ul></li>
<li><code>Thread scheduling</code>: running threads in some order

<ul>
<li><code>Thread state</code>

<ul>
<li><code>Running</code></li>
<li><code>Ready</code></li>
<li><code>Blocked</code></li>
<li><code>Exited</code> (not yet destroyed)</li>
</ul></li>
<li><code>Scheduling policies</code> to change states</li>
</ul></li>
<li><code>Thread scheduling functions</code>

<ul>
<li><code>thread_yield</code>

<ul>
<li><code>Running -&gt; Ready</code></li>
</ul></li>
<li><code>thread_sleep</code>

<ul>
<li><code>Running -&gt; Blocked</code></li>
</ul></li>
<li><code>thread_wakeup</code>

<ul>
<li><code>Blocked -&gt; Ready</code></li>
</ul></li>
</ul></li>
<li><code>Preemptive scheduling</code>

<ul>
<li><code>Scheduler</code> uses <code>timer interrupt</code> to control threads</li>
<li><code>Interrupt handler</code> calls yield on behalf of running thread

<ul>
<li>Normally <code>interrupt handler</code> returns to original call; here, it calls <code>thread_yield()</code> instead</li>
</ul></li>
</ul></li>
<li>Scheduler implementation

<ul>
<li>Thread structures maintained in <code>queues</code>

<ul>
<li><code>Ready queue</code>

<ul>
<li>Generally 1 per CPU</li>
</ul></li>
<li><code>Wait queue</code>

<ul>
<li>Separate <code>wait queues</code> for each type of event e.g. disk, console, timer, network, ...</li>
<li>Generally shared by CPUs</li>
</ul></li>
<li><code>Exited queue</code>

<ul>
<li>Generally shared by CPUs</li>
</ul></li>
</ul></li>
<li><code>Scheduling functions</code> move <code>threads</code> between <code>queues</code></li>
</ul></li>
</ul>

<h3><strong>Thread &amp; Context Switch</strong></h3>

<ul>
<li><p><code>context switch</code> (<code>process switch</code>) = <code>thread switch</code> + <code>address space switch</code></p>

<ul>
<li><code>Address space switch</code>

<ul>
<li>Updating <code>MMU&#39;s</code> registers</li>
<li>More expensive than <code>thread switch</code></li>
</ul></li>
<li><code>Context switch</code> v.s. <code>Mode switch</code>

<ul>
<li>Unrelated; the former switch threads, the latter switch CPU modes</li>
</ul></li>
</ul></li>
<li><p>Functions</p>

<ul>
<li><p><code>thread_yield</code></p>
<div class="highlight"><pre><code class="language-" data-lang="">thread_yield() {
    enqueue_ready_queue(current)
    next = choose_next_thread()
    thread_switch(current, next)
}
thread_switch(current, next) {
    save_processor_state(current-&gt;cpu_regs)
    ...
    restore_processor_state(next-&gt;cpu_regs)
}
</code></pre></div></li>
<li><p><code>thread_init</code></p>

<ul>
<li>Create the first (main) thread</li>
</ul></li>
<li><p><code>thread_create</code></p>

<ul>
<li>Allocate thread struct, stack memory, init PC, SP</li>
<li>Add to ready queue</li>
</ul></li>
</ul></li>
</ul>

<h3><strong>Thread Creation &amp; Termination</strong></h3>

<ul>
<li>Functions

<ul>
<li><code>thread_exit</code>

<ul>
<li>Does not destroy itself; switch to another thread and it will destroy this thread</li>
</ul></li>
<li><code>thread_destroy</code>

<ul>
<li>Actually destroy thread structure &amp; stack of exited threads</li>
</ul></li>
</ul></li>
</ul>

<h3><strong>Kernel Threads v.s. User Threads</strong></h3>

<table><thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">Kernel Threads</th>
<th style="text-align: left">User Threads</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">Implementation scope</td>
<td style="text-align: left">Implemented in kernel</td>
<td style="text-align: left">Implemented in user program</td>
</tr>
<tr>
<td style="text-align: left">Virtualization</td>
<td style="text-align: left">Virtualize CPU</td>
<td style="text-align: left">Virtualize kernel thread</td>
</tr>
<tr>
<td style="text-align: left">Switching cost</td>
<td style="text-align: left">Must run kernel code, expensive</td>
<td style="text-align: left">~procedure calls, less expensive</td>
</tr>
<tr>
<td style="text-align: left">Scheduling policy</td>
<td style="text-align: left">Fixed</td>
<td style="text-align: left">Custom definition</td>
</tr>
<tr>
<td style="text-align: left">Blocking system calls</td>
<td style="text-align: left">Switch to another kernel thread</td>
<td style="text-align: left">All threads (associated with the same kernel thread) block -&gt; overlap of I/O &amp; computations impossible</td>
</tr>
<tr>
<td style="text-align: left">Multiprocessors</td>
<td style="text-align: left">Threads use multiple CPUs concurrently</td>
<td style="text-align: left">Cannot use multiple CPUs consurrently</td>
</tr>
</tbody></table>

<ul>
<li><code>Kernel level scheduler</code> doesn&#39;t know about <code>user threads</code></li>
</ul>

<hr>

<h2><strong>Quick Questions</strong></h2>

<ol>
<li>Is the OS code run in a separate process? A separate thread? Does it need a process structure?

<ul>
<li>OS code runs when a process makes a system call or when an interrupt occurs. In either case, the OS generally runs in the thread and address space context of the user process, and hence it does not require its own process or thread state.</li>
</ul></li>
<li>What is the address space of an OS?

<ul>
<li>The entire physical memory</li>
</ul></li>
</ol>

		</div>

		<ul class="tag-list">
			

			<li class="tag">
				OS
			</li>

			

			<li class="tag">
				ECE344
			</li>

			

			<li class="tag">
				threads
			</li>

			
		</ul>

	</article>

	
		<div id="disqus_thread"></div>
<script>
	var disqus_config = function () {
	    this.page.url = "https://pyliaorachel.github.io";
	    this.page.identifier = "/blog/notes/os/2016/10/23/operating-system-threads.html";
	};
	(function() {
	    var d = document, s = d.createElement('script');
	    s.src = '//pyliaorachel.disqus.com/embed.js';
	    s.setAttribute('data-timestamp', +new Date());
	    (d.head || d.body).appendChild(s);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	
</div>
	</div>
</main>
		<footer>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-4 footer-link">
				<a href="mailto:rachel5566kk@gmail.com">
					<span class="icon icon-email">
						<img src="/assets/svg/email-logo.svg" alt="Email Logo">
					</span>
					<span class="username">rachel5566kk@gmail.com</span>
				</a>
			</div>
			<div class="col-md-4 footer-link">
				<a href="https://github.com/pyliaorachel"  target="_blank">
					<span class="icon icon-github">
						<img src="/assets/svg/github-logo.svg" alt="GitHub Logo">
					</span>
					<span class="username">pyliaorachel</span>
				</a>
			</div>
			<div class="col-md-4 footer-link">
				<a href="https://tw.linkedin.com/in/peiyu-liao" target="_blank">
					<span class="icon icon-linkedin">
						<img src="/assets/svg/linkedin-logo.svg" alt="LinkedIn Logo">
					</span>
					<span class="username">Peiyu Liao</span>
				</a>
			</div>
		</div><!-- /.row -->
		<div class="row">
			<div class="footer-copy-right">
				<p>2016	&copy; Liao Peiyu</p>
			</div >
		</div><!-- /.row -->
	</div><!-- /.container-fluid -->
</footer>
		<script type="text/javascript" src="/js/main.js"></script>
		<script type="text/javascript" src="/js/home.js"></script>
		<script id="dsq-count-scr" src="//pyliaorachel.disqus.com/count.js" async></script>
	</body>
</html>