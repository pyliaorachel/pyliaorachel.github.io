<!DOCTYPE html>
<html>
	<head>
		<title>Threads & Parallel Programming</title>
		<link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css">
		<link rel="stylesheet" href="/css/main.css" type="text/css">
		<link href="https://fonts.googleapis.com/css?family=Antic+Slab|Catamaran|Hind:300|Inconsolata|Josefin+Sans|Muli:300,400i|Poiret+One|Rajdhani:300|Rock+Salt|Ruda|Scope+One|Shadows+Into+Light|Source+Code+Pro|Space+Mono" rel="stylesheet">
		<link rel="stylesheet" href="/css/github-markdown.css">

		<!-- Place jquery before bootstrap -->
		<script type="text/javascript" src="/js/jquery.min.js"></script>
		<script type="text/javascript" src="/js/bootstrap.min.js"></script>
	</head>
	<body>
		<nav class="navbar navbar-default navbar-fixed-top">
	<div class="container-fluid">

		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">MyCoon</a>
		</div>

		<div class="collapse navbar-collapse" id="navbar-collapse">

			<form class="navbar-form navbar-left">
				<div class="form-group">
					<input type="text" class="form-control" placeholder="Search">
				</div>
				<button type="submit" class="btn btn-default">Submit</button>
			</form>

			<ul class="nav navbar-nav navbar-right" id="nav-links">
				<li class="nav-home"><a href="/">Home</a></li>
				<li class="dropdown nav-blog">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
						Blog<span class="caret"></span>
					</a>
					<ul class="dropdown-menu">
						<li><a href="/blog">MyCoon Blog</a></li>
						<li role="separator" class="divider"></li>
						<li><a href="/blog/categories">Categories</a></li>
						
							
						

						
							
							
							<li class="category">
								<a href="/blog/notes">
									<span>Notes</span>
									<span>29</span>
								</a>
							</li>
						
							
							
							<li class="category">
								<a href="/blog/tech">
									<span>Tech</span>
									<span>3</span>
								</a>
							</li>
						
						<li><a href="/blog/tags">Tags</a></li>
					</ul>
				</li>
				<li class="dropdown nav-tutorial">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
						Tutorials<span class="caret"></span>
					</a>
					<ul class="dropdown-menu">
						<li><a href="/tutorial">MyCoon Tutorial</a></li>
						<li role="separator" class="divider"></li>
						<li><a href="/tutorial/categories">Categories</a></li>
						
							
						

						
						<li><a href="/tutorial/tags">Tags</a></li>
					</ul>
				</li>
				<li  class="nav-project"><a href="/project">Projects</a></li>
				<li class="nav-special" id="special"><a href="#">?</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</div><!-- /.container-fluid -->
</nav>
		<main class="page-content post" aria-label="Content">
	<div class="post-wrapper">
		<div class="wrapper">
	<article class="post-article" itemscope itemtype="http://schema.org/BlogPosting">

		<header class="post-header">
			<h1 class="post-title" itemprop="name headline">Threads & Parallel Programming</h1>
			<p class="post-meta">Nov 27, 2016
				 • Notes
				 • pyliaorachel
			</p>
		</header>

		

		<span class="separator"> • • • </span>

		<div class="post-content" itemprop="articleBody">
			<h2>Content</h2>

<ol>
<li>Parallelism Overview

<ol>
<li>Standard Models of Parallelism</li>
<li>Speedup</li>
<li>Dependence</li>
</ol></li>
<li>Threads &amp; Processes

<ol>
<li>Pthreads</li>
<li>Synchronization</li>
</ol></li>
<li>Data Parallelism

<ol>
<li>Matrix Multiplication (Regular)</li>
<li>SOR (Regular)</li>
<li>Molecular Dynamics (Irregular)</li>
</ol></li>
<li>Task Parallelism

<ol>
<li>PIPE (Pipelines)</li>
<li>TSP (Task Queue)</li>
</ol></li>
</ol>

<!--more-->

<hr>

<h2>Parallelism Overview</h2>

<h3>Standard Models of Parallelism</h3>

<ul>
<li>Shared memory (pthreads)</li>
<li>Shared memory + data parallelism (OpenMP)</li>
<li>Message passing (MPI)</li>
<li>Transactional memory (TM)</li>
</ul>

<h3>Speedup</h3>

<ul>
<li><code>speedup on problem = sequential execution time of best known sequential algorithm / execution time on p processors</code>

<ul>
<li>Avoids picking easily parallelizable algorithm with poor sequential execution time</li>
</ul></li>
<li>Linear speedup is best to be achieved

<ul>
<li>Sub-linear speedup: due to overhead of <em>startup</em>, <em>synchronization</em>, <em>communication</em>, ...</li>
<li>Super-linear speedup

<ul>
<li>Cache/memory effects</li>
<li>Nondeterminism in search problems</li>
</ul></li>
</ul></li>
<li><strong>Amdahl&#39;s Law</strong>: if <code>1/s</code> of program is sequential, speedup will not be better than <code>s</code></li>
</ul>

<h3>Dependence</h3>

<ul>
<li><strong>True dependence</strong>

<ul>
<li><code>S2</code> reads a value written by <code>S1</code></li>
</ul></li>
<li><strong>Anti dependence</strong>

<ul>
<li><code>S2</code> writes a value read by <code>S1</code></li>
</ul></li>
<li><strong>Output dependence</strong>

<ul>
<li><code>S2</code> writes a value written by <code>S1</code></li>
</ul></li>
<li><strong>Loop carried dependence</strong>

<ul>
<li>Statements are part of the execution of a loop</li>
<li>e.g. <code>a[i] = f(a[i-1]) + 1;</code></li>
<li>Prevents loop iteration parallelization</li>
<li>Level of loop carried dependence: nesting depth of loop that carries dependence</li>
<li>&lt;-&gt; <strong>Loop independent dependence</strong></li>
</ul></li>
</ul>

<h2>Threads &amp; Processes</h2>

<ul>
<li>Similarities

<ul>
<li>Own logical control flow</li>
<li>Run concurrently with others</li>
</ul></li>
<li>Differences

<ul>
<li>Threads share code &amp; data, processes don&#39;t</li>
<li>Process control &amp; context switches more expensive than thread control &amp; thread switches</li>
</ul></li>
</ul>

<h3>Pthreads</h3>

<ul>
<li>User has to:

<ul>
<li>Decompose computation into parallel parts</li>
<li>Create/destroy threads</li>
<li>Add synchronization to ensure dependences covered</li>
</ul></li>
<li>Functions

<ul>
<li><code>pthread_create()</code></li>
<li><code>pthread_exit()</code></li>
<li><code>pthread_join()</code></li>
</ul></li>
</ul>

<h3>Synchronization</h3>

<h4>Parallelization Options</h4>

<ul>
<li><strong>Course-grained locking</strong>: 1 big lock for critical section

<ul>
<li>Limited parallelism</li>
<li>Easy to implement</li>
</ul></li>
<li><strong>Fine-grained locking</strong>: 1 lock per variable used in critical section

<ul>
<li>Good parallelism: less dependencies</li>
<li>Hard to implement

<ul>
<li>Deadlock, fault tolerance, priority inversion, ...</li>
</ul></li>
</ul></li>
<li><strong>Semaphores</strong></li>
<li><strong>Fork-Join</strong></li>
<li><strong>Barriers</strong></li>
<li><strong>Reductions</strong></li>
</ul>

<h2>Data Parallelism</h2>

<p>Processors do the same thing on different data.  </p>

<ul>
<li><strong>Regular</strong>: linear indexing

<ul>
<li>All arrays accessed through linear expressions of loop indices, known at compile time</li>
</ul></li>
<li><strong>Irregular</strong>: non-linear indexing

<ul>
<li>Some arrays accessed through non-linear expressions of loop indices, some only known at runtime</li>
<li>Difficult for parallelism based on <em>data distribution</em></li>
<li>Not difficult for parallelism based on <em>iteration distribution</em></li>
</ul></li>
</ul>

<h3>Matrix Multiplication (Regular)</h3>
<div class="highlight"><pre><code class="language-" data-lang="">for (i = 0; i &lt; n; i++) 
    for (j = 0; j &lt; n; j++)
        c[i][j] = 0.0; 
for (i = 0; i &lt; n; i++)
    for (j = 0; j &lt; n; j++)
        for (k = 0; k &lt; n; k++)
            c[i][j] += a[i][k] * b[k][j];
</code></pre></div>
<ul>
<li>No loop-carried dependences on i-/j- loop

<ul>
<li>Can run in parallel</li>
</ul></li>
<li><strong>Loop-carried dependence</strong> on k-loop</li>
<li>Data Distribution

<ul>
<li><strong>Block distribution</strong></li>
<li><strong>Block distribution by row</strong></li>
<li><strong>Block distribution by column</strong></li>
<li><strong>Cyclic distrubution by column</strong></li>
<li><strong>Block cyclic</strong></li>
<li><strong>Combinations</strong></li>
</ul></li>
</ul>

<h3>SOR (Regular)</h3>
<div class="highlight"><pre><code class="language-" data-lang="">for some number of timesteps/iterations {
    for (i = 1; i &lt; n; i++)
        for (j = 1; j &lt; n; j++)
            temp[i][j] = 0.25 *
                (grid[i-1][j] + grid[i+1][j] + grid[i][j-1] + grid[i][j+1]);
    for (i = 1; i &lt; n; i++)
        for (j = 1; j &lt; n; j++)
            grid[i][j] = temp[i][j];
}
</code></pre></div>
<ul>
<li>No dependences between 1st <code>(i,j)</code> loop nest

<ul>
<li>Can run in parallel</li>
</ul></li>
<li>No dependences between 2nd <code>(i,j)</code> loop nest

<ul>
<li>Can run in parallel</li>
</ul></li>
<li><strong>Anti-dependence</strong> between 1st &amp; 2nd loop nest in the same timestep

<ul>
<li>Fork-join</li>
</ul></li>
<li><strong>True-dependence</strong> between 2nd &amp; 1st loop nest of next timestep

<ul>
<li>Fork-join</li>
</ul></li>
</ul>

<h3>Molecular Dynamics (Irregular)</h3>
<div class="highlight"><pre><code class="language-" data-lang="">for some number of timesteps { 
    for all molecules i
        for all nearby molecules j
            force[i] += f(loc[i], loc[j]);
    for all molecules i
        loc[i] = g(loc[i], force[i]);
}

for each molecule i
    number of nearby molecules count[i]
    array of indices of nearby molecules index[j] // 0 &lt;= j &lt; count[i]

for some number of timesteps { 
    for (i = 0; i &lt; num_mol; i++)
        for (j = 0; j &lt; count[i]; j++)
            force[i] += f(loc[i], loc[index[j]]);
    for (i = 0; i &lt; num_mol; i++)
        loc[i] = g(loc[i], force[i]);
}
</code></pre></div>
<ul>
<li>No loop-carried dependences in 1st i-loop

<ul>
<li>Can run in parallel</li>
<li>May have <strong>load balancing</strong> problem</li>
</ul></li>
<li><strong>Loop-carried dependence (reduction)</strong> on j-loop</li>
<li>No loop-carried dependences in 2nd i-loop

<ul>
<li>Can run in parallel</li>
</ul></li>
<li><strong>True-dependence</strong> between 1st &amp; 2nd i-loop

<ul>
<li>Fork-join between loops</li>
</ul></li>
</ul>

<h2>Task Parallelism</h2>

<p>Processors do different tasks.</p>

<h3>PIPE (Pipelines)</h3>

<ol>
<li><p>Case 1</p>
<div class="highlight"><pre><code class="language-" data-lang="">for (i =0 ; i &lt; num_pic, read(in_pic[i]); i++) {    
    int_pic_1[i] = trans1(in_pic[i]); 
    int_pic_2[i] = trans2(int_pic_1[i]); 
    int_pic_3[i] = trans3(int_pic_2[i]); 
    out_pic[i] = trans4(int_pic_3[i]);
}
</code></pre></div><div class="highlight"><pre><code class="language-" data-lang="">// Assign each transformation to a processor
// Processor 1
for (i = 0; i &lt; num_pics, read(in_pic[i]); i++) { 
    int_pic_1[i] = trans1(in_pic[i]); 
    signal(event_1_2[i]);
}
// Processor 2
for (i = 0; i &lt; num_pics; i++) {
    wait(event_1_2[i]);
    int_pic_2[i] = trans1(int_pic_1[i]);
    signal(event_2_3[i]);
}
// Processor 3
...
// Processor 4
for (i = 0; i &lt; num_pics; i++) {
    wait(event_3_4[i]);
    out_pic[i] = trans1(int_pic_3[i]); 
}
</code></pre></div>
<ul>
<li>Problem

<ul>
<li>Each stage (transformation) may take different time to finish</li>
<li>Stages take a variable amount of time</li>
</ul></li>
<li>Use <strong>semaphore_wait/signal</strong> with <code>pthread</code></li>
</ul></li>
<li><p>Case 2</p>
<div class="highlight"><pre><code class="language-" data-lang="">for (i =0 ; i &lt; num_pic, read(in_pic[i]); i++) {    
    int_pic_1 = trans1(in_pic); 
    int_pic_2 = trans2(int_pic_1); 
    int_pic_3 = trans3(int_pic_2); 
    out_pic = trans4(int_pic_3);
}
</code></pre></div>
<ul>
<li>Anti-dependence between stages -&gt; no parallelism

<ul>
<li><strong>Privatization</strong></li>
<li><strong>Buffer</strong> between stages; block when buffers are full/empty</li>
</ul></li>
</ul></li>
</ol>

<h3>TSP (Task Queue)</h3>
<div class="highlight"><pre><code class="language-" data-lang="">init_q(); init_best();
while ((p = de_queue()) != NULL) {
    for each expansion by one city { 
        q = add_city(p);
        if (complete(q)) { update_best(q) } 
        else { en_queue(q) }
    }
}
</code></pre></div>
<p>Balance between <strong>granularity for load balance</strong> and <strong>overhead for synchronization</strong>.</p>

<ol>
<li>Each process one expansion</li>
<li><p>Each process do expansion of one partial path</p>
<div class="highlight"><pre><code class="language-" data-lang="">en_queue()/de_queue() {
    pthreads_mutex_lock(&amp;queue);
    ...;
    pthreads_mutex_unlock(&amp;queue);
}
update_best() {
    pthreads_mutex_lock(&amp;best);
    ...;
    pthreads_mutex_unlock(&amp;best);
}
de_queue() {
    while ((q is empty) and (not done)) {
        waiting++;
        if (waiting == p) {
            done = true;
            pthreads_cond_broadcast(&amp;empty, &amp;queue);
        }
        else {
            pthreads_cond_wait(&amp;empty, &amp;queue);
            waiting--; 
        }
    }
    if (done) return null; 
    else remove and return head of the queue; 
}
</code></pre></div></li>
<li><p>Each process do expansion of multiple partial path</p></li>
</ol>

<h4>Busy Waiting</h4>
<div class="highlight"><pre><code class="language-" data-lang="">initially: flag = 0;
P1: produce data; flag = 1;
P2: while (!flag); consume data;
</code></pre></div>
<p>Used when <strong>few threads competing for core</strong> or <strong>short critical sections</strong>.</p>

		</div>

		<ul class="tag-list">
			

			<li class="tag">
				Optimization
			</li>

			

			<li class="tag">
				ECE454
			</li>

			
		</ul>

	</article>

	
		<div id="disqus_thread"></div>
<script>
	var disqus_config = function () {
	    this.page.url = "https://pyliaorachel.github.io";
	    this.page.identifier = "/blog/notes/optimization/2016/11/27/threads-and-parallel-programming.html";
	};
	(function() {
	    var d = document, s = d.createElement('script');
	    s.src = '//pyliaorachel.disqus.com/embed.js';
	    s.setAttribute('data-timestamp', +new Date());
	    (d.head || d.body).appendChild(s);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	
</div>
	</div>
</main>
		<footer>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-4 footer-link">
				<a href="mailto:rachel5566kk@gmail.com">
					<span class="icon icon-email">
						<img src="/assets/svg/email-logo.svg" alt="Email Logo">
					</span>
					<span class="username">rachel5566kk@gmail.com</span>
				</a>
			</div>
			<div class="col-md-4 footer-link">
				<a href="https://github.com/pyliaorachel"  target="_blank">
					<span class="icon icon-github">
						<img src="/assets/svg/github-logo.svg" alt="GitHub Logo">
					</span>
					<span class="username">pyliaorachel</span>
				</a>
			</div>
			<div class="col-md-4 footer-link">
				<a href="https://tw.linkedin.com/in/peiyu-liao" target="_blank">
					<span class="icon icon-linkedin">
						<img src="/assets/svg/linkedin-logo.svg" alt="LinkedIn Logo">
					</span>
					<span class="username">Peiyu Liao</span>
				</a>
			</div>
		</div><!-- /.row -->
		<div class="row">
			<div class="footer-copy-right">
				<p>2016	&copy; Liao Peiyu</p>
			</div >
		</div><!-- /.row -->
	</div><!-- /.container-fluid -->
</footer>
		<script type="text/javascript" src="/js/main.js"></script>
		<script type="text/javascript" src="/js/home.js"></script>
		<script id="dsq-count-scr" src="//pyliaorachel.disqus.com/count.js" async></script>
	</body>
</html>