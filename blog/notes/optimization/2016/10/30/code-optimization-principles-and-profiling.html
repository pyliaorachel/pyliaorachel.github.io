<!DOCTYPE html>
<html>
	<head>
		<title>Code Optimization Principles & Profiling</title>
		<link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css">
		<link rel="stylesheet" href="/css/main.css" type="text/css">
		<link href="https://fonts.googleapis.com/css?family=Antic+Slab|Catamaran|Hind:300|Inconsolata|Josefin+Sans|Muli:300,400i|Poiret+One|Rajdhani:300|Rock+Salt|Ruda|Scope+One|Shadows+Into+Light|Source+Code+Pro|Space+Mono" rel="stylesheet">
		<link rel="stylesheet" href="/css/github-markdown.css">

		<!-- Place jquery before bootstrap -->
		<script type="text/javascript" src="/js/jquery.min.js"></script>
		<script type="text/javascript" src="/js/bootstrap.min.js"></script>
	</head>
	<body>
		<nav class="navbar navbar-default navbar-fixed-top">
	<div class="container-fluid">

		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">MyCoon</a>
		</div>

		<div class="collapse navbar-collapse" id="navbar-collapse">

			<form class="navbar-form navbar-left">
				<div class="form-group">
					<input type="text" class="form-control" placeholder="Search">
				</div>
				<button type="submit" class="btn btn-default">Submit</button>
			</form>

			<ul class="nav navbar-nav navbar-right" id="nav-links">
				<li class="nav-home"><a href="/">Home</a></li>
				<li class="dropdown nav-blog">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
						Blog<span class="caret"></span>
					</a>
					<ul class="dropdown-menu">
						<li><a href="/blog">MyCoon Blog</a></li>
						<li role="separator" class="divider"></li>
						<li><a href="/blog/categories">Categories</a></li>
						
							
						

						
							
							
							<li class="category">
								<a href="/blog/notes">
									<span>Notes</span>
									<span>23</span>
								</a>
							</li>
						
							
							
							<li class="category">
								<a href="/blog/tech">
									<span>Tech</span>
									<span>3</span>
								</a>
							</li>
						
						<li><a href="/blog/tags">Tags</a></li>
					</ul>
				</li>
				<li class="dropdown nav-tutorial">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
						Tutorials<span class="caret"></span>
					</a>
					<ul class="dropdown-menu">
						<li><a href="/tutorial">MyCoon Tutorial</a></li>
						<li role="separator" class="divider"></li>
						<li><a href="/tutorial/categories">Categories</a></li>
						
							
						

						
						<li><a href="/tutorial/tags">Tags</a></li>
					</ul>
				</li>
				<li  class="nav-project"><a href="/project">Projects</a></li>
				<li class="nav-special" id="special"><a href="#">?</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</div><!-- /.container-fluid -->
</nav>
		<main class="page-content post" aria-label="Content">
	<div class="post-wrapper">
		<div class="wrapper">
	<article class="post-article" itemscope itemtype="http://schema.org/BlogPosting">

		<header class="post-header">
			<h1 class="post-title" itemprop="name headline">Code Optimization Principles & Profiling</h1>
			<p class="post-meta">Oct 30, 2016
				 • Notes
				 • pyliaorachel
			</p>
		</header>

		

		<span class="separator"> • • • </span>

		<div class="post-content" itemprop="articleBody">
			<h2>Content</h2>

<ol>
<li>Measurements of Programs &amp; Computers

<ol>
<li>Measurements</li>
<li>Amdahl&#39;s Law</li>
<li>Tools for Measuring</li>
</ol></li>
<li>Compiler Optimizations

<ol>
<li>Common Compiler Optimizations</li>
</ol></li>
<li>Basics of Computer Architecture

<ol>
<li>Pipelines</li>
<li>Branch Prediction</li>
<li>Out-of-Order Execution</li>
<li>Superscalar &amp; Simultaneous Multithreading(SMT)/Hyperthreading</li>
</ol></li>
</ol>

<!--more-->

<hr>

<h2>Measurements of Programs &amp; Computers</h2>

<h3>Measurements</h3>

<ul>
<li><strong>IPS</strong>: instructions per second</li>
<li><strong>FLOPS</strong>: floating point operations per second</li>
<li><strong>IPC</strong>: instructions per cycle</li>
<li><strong>CPI</strong>: cycles per instruction</li>
</ul>

<h3>Amdahl&#39;s Law</h3>

<ul>
<li><code>speedup = OldTime/NewTime</code></li>
<li><code>NewTime = OldTime x [(1 - f) + f/s]</code><br>
<code>speedup = 1 / (1 - f + f/s)</code>

<ul>
<li><code>f</code> = fraction of execution time the optimization applies to</li>
<li><code>s</code> = improvement factor</li>
</ul></li>
</ul>

<h3>Tools for Measuring</h3>

<ul>
<li><strong>S/W timers</strong>

<ul>
<li>C library: <code>&lt;sys/times.h&gt;</code></li>
<li>OS-level timers: <code>/usr/bin/time</code></li>
</ul></li>
<li><strong>H/W timers &amp; performance counters</strong>

<ul>
<li>Built into processor chip: low-level architecture events e.g. cache misses, branch mispredictions, ...</li>
<li>S/W packages to make them easier to use: <code>perf</code></li>
</ul></li>
<li><p><strong>Instrumentation</strong></p>

<ul>
<li>Self implemented codes</li>
<li><strong>gprof</strong>

<ul>
<li>Periodically interrupt program</li>
<li>Measure <em>time spent</em> &amp; <em># of calls made</em> in each function</li>
</ul></li>
<li><strong>gcov</strong>

<ul>
<li>Profile of execution within a function e.g. # of times each line of code was executed, which loops/conditional statements are important</li>
</ul></li>
<li>Disturbing the system slows down execution</li>
<li><p>Comparison</p>

<table><thead>
<tr>
<th style="text-align: left"></th>
<th style="text-align: left">gprof</th>
<th style="text-align: left">gcov</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left">Compile</td>
<td style="text-align: left">faster (insert counter func for each function)</td>
<td style="text-align: left">slower (insert counter func for each line)</td>
</tr>
<tr>
<td style="text-align: left">Size</td>
<td style="text-align: left">smaller</td>
<td style="text-align: left">bigger</td>
</tr>
<tr>
<td style="text-align: left">Runtime</td>
<td style="text-align: left">slower (frequent interrupts)</td>
<td style="text-align: left">faster</td>
</tr>
</tbody></table></li>
</ul></li>
</ul>

<h2>Compiler Optimizations</h2>

<ul>
<li>Preserve correctness</li>
<li>Improve performance

<ul>
<li>Fewer CPI

<ul>
<li>Schedule instructions</li>
<li>Improve cache/memory behavior</li>
</ul></li>
<li>Fewer instructions</li>
</ul></li>
<li>Worth the effort</li>
</ul>
<div class="highlight"><pre><code class="language-" data-lang="">---&gt; Front End ---&gt; Optimizer ---&gt; Code Generator ---&gt;
 HLL            IR             IR                 LLL
</code></pre></div>
<ul>
<li>Limitations

<ul>
<li>Cannot change program behavior</li>
<li>Inter-procedural analysis too expensive -&gt; most analysis performed within procedures</li>
<li>Hard to anticipate run-time inputs -&gt; most analysis based on static information</li>
<li>Must be conservative</li>
</ul></li>
<li>Programmers should:

<ul>
<li>Select best algorithm</li>
<li>Write readable &amp; maintainable code</li>
<li><strong>Eliminate optimization blockers</strong>

<ul>
<li>Memory aliasing

<ul>
<li>2 different memory references specific single location</li>
</ul></li>
<li>Pocedural side-effects</li>
</ul></li>
</ul></li>
</ul>

<h3>Common Compiler Optimizations</h3>

<ul>
<li>Machine independent

<ul>
<li>Constant propagation</li>
<li>Constant folding</li>
<li>Common subexpression elimination</li>
<li>Dead code elimination</li>
<li>Loop invariant code motion</li>
<li>Function inlining

<ul>
<li>Space-speed tradeoff</li>
<li>Overloading issue</li>
</ul></li>
<li>Reduction in strength: replace costly operation with simpler one

<ul>
<li>Shifting (machine-dependent)</li>
<li>Make use of registers</li>
</ul></li>
<li>Direct access

<ul>
<li>Avoid bound checking</li>
</ul></li>
</ul></li>
<li>Machine dependent

<ul>
<li>Instruction scheduling</li>
<li>Loop unrolling

<ul>
<li>Enables more aggressive instruction scheduling</li>
</ul></li>
<li>Parallel unrolling</li>
</ul></li>
</ul>

<h2>Basics of Computer Architecture</h2>

<ul>
<li>RISC: simpler instructions -&gt; <strong>pipeline</strong></li>
<li>64-bit: larger databases, counter not overflowing, better math performance -&gt; code size increases</li>
</ul>

<h3>Pipelines</h3>

<ul>
<li>Important factors

<ul>
<li>Branch prediction</li>
<li>Data dependency</li>
</ul></li>
<li>Pipeline deeper -&gt; misprediction penalty larger</li>
<li>Multiple instruction issue: flushing &amp; refetching more instructions</li>
<li>OOP: More indirect branches to be predicted</li>
</ul>

<h3>Branch Prediction</h3>

<ul>
<li>Predict future based on history</li>
<li>Global predictor: predict based on <em>global</em> &amp; <em>local</em> history

<ul>
<li><strong>(m, n) prediction</strong>: m-bit global x n-bit local</li>
</ul></li>
</ul>

<h3>Out-of-Order Execution</h3>

<ul>
<li>Solve <strong>data dependency</strong></li>
<li>Mask <strong>cache miss delay</strong></li>
</ul>

<h3>Superscalar &amp; Simultaneous Multithreading(SMT)/Hyperthreading</h3>
<div class="highlight"><pre><code class="language-" data-lang="">    1               1 2             1 2 6
    2               3 4 5           3 4 5   
    3               6               7 8
    4               7 8             9
    5               9
    6
    7
    8
    9
single-issue     superscalar    out-of-order superscalar

    1   1'          1 2 6           1 2 1'
    2   2'          3 4 5           2'6 6'
    3   3'          7 8             3'3 5
    4   4'          9               4 4'5'
    5   5'          1'2'6'          7 8 7'
    6   6'          3'4'5'          9 8'
    7   7'          7'8'            9'
    8   8'          9'
    9   9'
2 applications      fast        hyperthreading
                context switching
</code></pre></div>
		</div>

		<ul class="tag-list">
			

			<li class="tag">
				Optimization
			</li>

			

			<li class="tag">
				ECE454
			</li>

			
		</ul>

	</article>

	
		<div id="disqus_thread"></div>
<script>
	var disqus_config = function () {
	    this.page.url = "https://pyliaorachel.github.io";
	    this.page.identifier = "/blog/notes/optimization/2016/10/30/code-optimization-principles-and-profiling.html";
	};
	(function() {
	    var d = document, s = d.createElement('script');
	    s.src = '//pyliaorachel.disqus.com/embed.js';
	    s.setAttribute('data-timestamp', +new Date());
	    (d.head || d.body).appendChild(s);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	
</div>
	</div>
</main>
		<footer>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-4 footer-link">
				<a href="mailto:rachel5566kk@gmail.com">
					<span class="icon icon-email">
						<img src="/assets/svg/email-logo.svg" alt="Email Logo">
					</span>
					<span class="username">rachel5566kk@gmail.com</span>
				</a>
			</div>
			<div class="col-md-4 footer-link">
				<a href="https://github.com/pyliaorachel"  target="_blank">
					<span class="icon icon-github">
						<img src="/assets/svg/github-logo.svg" alt="GitHub Logo">
					</span>
					<span class="username">pyliaorachel</span>
				</a>
			</div>
			<div class="col-md-4 footer-link">
				<a href="https://tw.linkedin.com/in/peiyu-liao" target="_blank">
					<span class="icon icon-linkedin">
						<img src="/assets/svg/linkedin-logo.svg" alt="LinkedIn Logo">
					</span>
					<span class="username">Peiyu Liao</span>
				</a>
			</div>
		</div><!-- /.row -->
		<div class="row">
			<div class="footer-copy-right">
				<p>2016	&copy; Liao Peiyu</p>
			</div >
		</div><!-- /.row -->
	</div><!-- /.container-fluid -->
</footer>
		<script type="text/javascript" src="/js/main.js"></script>
		<script type="text/javascript" src="/js/home.js"></script>
		<script id="dsq-count-scr" src="//pyliaorachel.disqus.com/count.js" async></script>
	</body>
</html>