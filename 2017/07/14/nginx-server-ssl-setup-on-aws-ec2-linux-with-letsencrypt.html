<p>This post is a followup on <a href="https://pyliaorachel.github.io/blog/tech/system/2017/07/07/flask-app-with-gunicorn-on-nginx-server-upon-aws-ec2-linux.html">my previous post on setting up an nginx server on AWS EC2 instance</a>, and now we are going to support HTTPS to secure our website using a free SSL certificate authority (CA) <a href="https://letsencrypt.org/">letsencrypt</a>.</p>

<!--more-->
<hr />

<p>Before you start:</p>

<ol>
  <li>Obtain a domain name and set it up in your EC2 console to point to the public DNS.</li>
  <li>Understand the basic mechanism of <a href="https://letsencrypt.org/how-it-works/">letsencrypt</a>. This is key to understanding why your setup does or does not work.</li>
  <li>Remember to open up 443 port and allow source from <code class="highlighter-rouge">0.0.0.0/0</code> in your EC2 console so that ACME can hit on you.</li>
  <li>We are going to use <a href="https://certbot.eff.org/">certbot</a>, which handles all the tedious works to communicate with <code class="highlighter-rouge">letsencrypt</code> for us.</li>
</ol>

<p>And here are the steps:</p>

<ol>
  <li>Obtain the certificate using <code class="highlighter-rouge">certbot</code></li>
  <li>Modify your <code class="highlighter-rouge">nginx</code> configuration to enable SSL</li>
</ol>

<h4 id="obtain-the-certificate">Obtain the Certificate</h4>

<p>Get <code class="highlighter-rouge">certbot</code> first:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>wget https://dl.eff.org/certbot-auto
<span class="gp">$ </span>chmod a+x certbot-auto
</code></pre>
</div>

<p>There are several plugins to use to help us retrieve the certificate. Two popular ones are <a href="http://letsencrypt.readthedocs.io/en/latest/using.html#webroot">webroot</a> and <a href="http://letsencrypt.readthedocs.io/en/latest/using.html#standalone">standalone</a>. If you do not want to stop your server, use <code class="highlighter-rouge">webroot</code>; if you do not want to use existing server software, use <code class="highlighter-rouge">standalone</code>. We will use <code class="highlighter-rouge">standalone</code> below.</p>

<blockquote>
  <h6 id="using-webroot">Using webroot</h6>

  <p>To retrieve the certificate from the CA, your server needs to solve some <a href="http://letsencrypt.readthedocs.io/en/latest/using.html#getting-certificates-and-choosing-plugins">challenges</a>. The challenge is elaborated <a href="https://letsencrypt.org/how-it-works/">here</a>. If you choose to use <code class="highlighter-rouge">webroot</code> as the plugin, the thing to note is that the configuration of your server needs to be able to serve the files created in <code class="highlighter-rouge">${webroot}/.well-known/acme-challenge</code>. You might want to verify that <code class="highlighter-rouge">GET /.well-known/acme-challenge</code> is accessible first.</p>
</blockquote>

<p>To run as standalone, remember to close your services that listen on 80 or 443 ports.</p>

<p>Let’s write a config file first. We’ll use <code class="highlighter-rouge">example.com</code> as our domain name. At <code class="highlighter-rouge">/etc/letsencrypt/configs/example.com.conf</code>:</p>

<div class="language-conf highlighter-rouge"><pre class="highlight"><code><span class="c"># domains to retrieve certificate
</span><span class="n">domains</span> = <span class="n">example</span>.<span class="n">com</span>

<span class="c"># increase key size
</span><span class="n">rsa</span>-<span class="n">key</span>-<span class="n">size</span> = <span class="m">4096</span>

<span class="c"># the CA endpoint server
</span><span class="n">server</span> = <span class="n">https</span>://<span class="n">acme</span>-<span class="n">v01</span>.<span class="n">api</span>.<span class="n">letsencrypt</span>.<span class="n">org</span>/<span class="n">directory</span>

<span class="c"># the email to receive renewal reminders, IIRC
</span><span class="n">email</span> = <span class="n">example</span>@<span class="n">example</span>.<span class="n">com</span> 

<span class="c"># turn off the ncurses UI, we want this to be run as a cronjob
</span><span class="n">text</span> = <span class="n">True</span>
</code></pre>
</div>

<p>Run <code class="highlighter-rouge">certbot</code>:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>./certbot-auto --standalone --config /etc/letsencrypt/configs/example.com.conf certonly
</code></pre>
</div>

<p>You can skip the above config file as well:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>./certbot-auto --standalone -d example.com certonly
<span class="c"># ...Answer some config questions</span>
</code></pre>
</div>

<p>Now you should see</p>

<div class="highlighter-rouge"><pre class="highlight"><code>
IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at
   /etc/letsencrypt/live/example.com/fullchain.pem. Your cert will
   expire on xxxx-xx-xx. To obtain a new version of the certificate in
   the future, simply run Let's Encrypt again.
</code></pre>
</div>

<p>You can verify that the certificate and keys exist:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Certificate
/etc/letsencrypt/live/example.com/cert.pem

# Full Chain 
/etc/letsencrypt/live/example.com/fullchain.pem

# Private Key 
/etc/letsencrypt/live/example.com/privkey.pem
</code></pre>
</div>

<h4 id="modify-nginx-configuration">Modify <code class="highlighter-rouge">nginx</code> configuration</h4>

<p>Now you’ve got the certificate, we need to configure the nginx for it to take up HTTPS requests.</p>

<p>Open up your <code class="highlighter-rouge">/etc/nginx/nginx.conf</code> and modify:</p>

<div class="language-conf highlighter-rouge"><pre class="highlight"><code>...

<span class="n">http</span> {

    ...

    <span class="n">server</span> {
        <span class="n">listen</span> <span class="m">80</span>;
        <span class="n">server_name</span>  <span class="n">example</span>.<span class="n">com</span>;
        <span class="n">root</span>         /<span class="n">usr</span>/<span class="n">share</span>/<span class="n">nginx</span>/<span class="n">html</span>;

        <span class="c"># Load configuration files for the default server block.
</span>        <span class="n">include</span> /<span class="n">etc</span>/<span class="n">nginx</span>/<span class="n">default</span>.<span class="n">d</span>/*.<span class="n">conf</span>;

        <span class="n">location</span> / {
            <span class="c"># redirect to HTTPS
</span>            <span class="n">return</span> <span class="m">301</span> <span class="n">https</span>://$<span class="n">server_name</span>$<span class="n">request_uri</span>;
        }

        ...
    }

    <span class="c"># Settings for a TLS enabled server.
</span>    <span class="n">server</span> {
        <span class="n">listen</span> <span class="m">443</span> <span class="n">ssl</span>;
        <span class="n">server_name</span>  <span class="n">example</span>.<span class="n">com</span>;
        <span class="n">root</span>         /<span class="n">usr</span>/<span class="n">share</span>/<span class="n">nginx</span>/<span class="n">html</span>;

        <span class="n">ssl_certificate</span> <span class="s2">"/etc/letsencrypt/live/example.com/fullchain.pem"</span>;
        <span class="n">ssl_certificate_key</span> <span class="s2">"/etc/letsencrypt/live/example.com/privkey.pem"</span>;

        <span class="c"># Automatically route HTTP to HTTPS
</span>        <span class="n">add_header</span> <span class="n">Strict</span>-<span class="n">Transport</span>-<span class="n">Security</span> <span class="s2">"max-age=31536000"</span>;
  
        <span class="n">include</span> /<span class="n">etc</span>/<span class="n">nginx</span>/<span class="n">default</span>.<span class="n">d</span>/*.<span class="n">conf</span>;

        <span class="n">location</span> / {
            <span class="c"># These are esstential, or your flask app may not correctly redirect
</span>            <span class="n">proxy_set_header</span> <span class="n">Host</span> $<span class="n">host</span>;
            <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Real</span>-<span class="n">IP</span> $<span class="n">remote_addr</span>;
            <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Forwarded</span>-<span class="n">Proto</span> <span class="n">https</span>;
            <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Forwarded</span>-<span class="n">Host</span> $<span class="n">host</span>;
            <span class="n">proxy_set_header</span> <span class="n">X</span>-<span class="n">Forwarded</span>-<span class="n">For</span> $<span class="n">proxy_add_x_forwarded_for</span>;

            <span class="c"># Pass to our WSGI server
</span>            <span class="n">proxy_pass</span> <span class="n">http</span>://<span class="n">unix</span>:/<span class="n">home</span>/<span class="n">ec2</span>-<span class="n">user</span>/<span class="n">myproject</span>/<span class="n">myproject</span>.<span class="n">sock</span>;
        }

        ...
    }
}
</code></pre>
</div>

<p>Reload your <code class="highlighter-rouge">nginx</code>:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>sudo service nginx reload
</code></pre>
</div>

<p>Now you should access your website using <code class="highlighter-rouge">https</code>.</p>

<p>Not that the certificate expires in 3 months, so you may want to refer to the nice tutorials in the reference links to set up a cron job and make the renewals.</p>

<blockquote>
  <h6 id="debug-tips">Debug Tips</h6>
  <ol>
    <li>Logs reside in <code class="highlighter-rouge">/var/log/letsencrypt/letsencrypt.log</code></li>
    <li>If there are permissoin problems, run <code class="highlighter-rouge">sudo su - nginx -s /bin/bash -c "ls /home/ec2-user/myproject/myproject.sock"</code> to test permission from the viewpoint of <code class="highlighter-rouge">nginx</code></li>
  </ol>
</blockquote>

<h2 id="references">References</h2>
<ul>
  <li><a href="http://letsencrypt.readthedocs.io/en/latest/using.html">Certbot Userguide</a></li>
  <li><a href="https://medium.freecodecamp.org/going-https-on-amazon-ec2-ubuntu-14-04-with-lets-encrypt-certbot-on-nginx-696770649e76">Using the Let’s Encrypt Certbot to get HTTPS on your Amazon EC2 NGINX box</a></li>
  <li><a href="https://gist.github.com/xrstf/581981008b6be0d2224f">Let’s Encrypt on Ubuntu 14.04, nginx with webroot auth</a></li>
  <li><a href="https://loune.net/2016/01/https-with-lets-encrypt-ssl-and-nginx/">HTTPS with Let’s Encrypt SSL and Nginx (using certbot)</a></li>
  <li><a href="https://nouveauframework.org/blog/installing-letsencrypts-free-ssl-amazon-linux/">Installing LetsEncrypt’s free SSL on Amazon Linux</a></li>
</ul>
