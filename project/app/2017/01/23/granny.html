<!DOCTYPE html>
<html>
	<head>
		<title>Granny</title>
		<link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css">
		<link rel="stylesheet" href="/css/main.css" type="text/css">
		<link href="https://fonts.googleapis.com/css?family=Antic+Slab|Catamaran|Hind:300|Inconsolata|Josefin+Sans|Muli:300,400i|Poiret+One|Rajdhani:300|Rock+Salt|Ruda|Scope+One|Shadows+Into+Light|Source+Code+Pro|Space+Mono|Amatic+SC:700" rel="stylesheet">
		<link rel="stylesheet" href="/css/github-markdown.css">

		<!-- Place jquery before bootstrap -->
		<script type="text/javascript" src="/js/jquery.min.js"></script>
		<script type="text/javascript" src="/js/bootstrap.min.js"></script>
	</head>
	<body>
		<nav class="navbar navbar-default navbar-fixed-top">
	<div class="container-fluid">

		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">MyCoon</a>
		</div>

		<div class="collapse navbar-collapse" id="navbar-collapse">

			<form class="navbar-form navbar-left">
				<div class="form-group">
					<input type="text" class="form-control" placeholder="Search">
				</div>
				<button type="submit" class="btn btn-default">Submit</button>
			</form>

			<ul class="nav navbar-nav navbar-right" id="nav-links">
				<li class="nav-home"><a href="/">Home</a></li>
				<li class="dropdown nav-blog">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
						Blog<span class="caret"></span>
					</a>
					<ul class="dropdown-menu">
						<li><a href="/blog">MyCoon Blog</a></li>
						<li role="separator" class="divider"></li>
						<li><a href="/blog/categories">Categories</a></li>
						
							
						

						
							
							
							<li class="category">
								<a href="/blog/tech">
									<span>Tech</span>
									<span>8</span>
								</a>
							</li>
						
							
							
							<li class="category">
								<a href="/blog/notes">
									<span>Notes</span>
									<span>5</span>
								</a>
							</li>
						
						<li><a href="/blog/tags">Tags</a></li>
					</ul>
				</li>
				<li class="dropdown nav-tutorial">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
						Tutorials<span class="caret"></span>
					</a>
					<ul class="dropdown-menu">
						<li><a href="/tutorial">MyCoon Tutorial</a></li>
						<li role="separator" class="divider"></li>
						<li><a href="/tutorial/categories">Categories</a></li>
						
							
						

						
							
							
							<li class="category">
								<a href="/tutorial/devops">
								<span>DevOps</span>
								<span>1</span></a>
							</li>
						
							
							
							<li class="category">
								<a href="/tutorial/hardware">
								<span>Hardware</span>
								<span>1</span></a>
							</li>
						
						<li><a href="/tutorial/tags">Tags</a></li>
					</ul>
				</li>
				<li  class="nav-project"><a href="/project">Projects</a></li>
				<li class="nav-special" id="special"><a href="#">?</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</div><!-- /.container-fluid -->
</nav>
		<main class="page-content post" aria-label="Content">
	<div class="post-wrapper">
		<div class="wrapper">
	<article class="post-article" itemscope itemtype="http://schema.org/BlogPosting">

		<header class="post-header">
			<h1 class="post-title" itemprop="name headline">Granny</h1>
			<p class="post-meta">Jan 23, 2017
				 • App
				 • pyliaorachel
			</p>
		</header>

		

		<span class="separator"> • • • </span>

		<div class="post-content" itemprop="articleBody">
			<p align="center"><img width="400px" height="400px" src="https://raw.githubusercontent.com/pyliaorachel/granny/master/img/granny-icon.jpg" /></p>

<p><a href="https://github.com/pyliaorachel/granny">Granny</a> is an app aimed at helping people to understand their emotions without having to overcome many difficulties when trying to find an assistant. You can easily open the app and talk to Granny, and Granny will respond with a face reflective of your emotions. Emotion history will also be kepted as a diary <em>(not yet implemented)</em>. </p>

<p>Details can be found <a href="https://devpost.com/software/granny">here</a>.</p>

<!--more-->

<hr>

<p><img width="245px" height="416px" src="https://raw.githubusercontent.com/pyliaorachel/granny/master/img/happy_granny.gif" />
<img width="245px" height="414px" src="https://raw.githubusercontent.com/pyliaorachel/granny/master/img/sad_neutral_granny.gif" />
<img width="245px" height="414px" src="https://raw.githubusercontent.com/pyliaorachel/granny/master/img/surprised_angry_granny.gif" /></p>

<h2>React Native</h2>

<p>This app was created in a hackathon and won us the first prize. It was built on <a href="https://facebook.github.io/react-native/">React Native</a>, which extremely accelerated the development of the app. I strongly recommend this powerful yet easy-to-learn framework for any developers ready to attend a hackathon.</p>

<p>Some problems encountered with Android development and solutions:</p>

<ol>
<li>Make sure in <code>android/app/build.bundle</code>, <code>buildToolsVersion</code>(in my case, 23.0.1) has the same version as your SDK.</li>
<li>To enable developer mode on an android device, go to <code>Settings &gt; About Phone &gt; Build Number</code> and tap on it for 7 times.</li>
<li>If any error shows up when you open AndroidStudio and is trying to run the app, just follow the instructions to upgrade anything they require.</li>
</ol>

<h2>Emotion API</h2>

<p>The hackathon was held by Microsoft, and Azure was required in all projects. We chose <a href="https://dev.projectoxford.ai/docs/services/5639d931ca73072154c1ce89/operations/563b31ea778daf121cc3a5fa">Emotion API</a> to capture the emotions from the user&#39;s face. There is a hidden camera (<a href="https://github.com/lwansbrough/react-native-camera">react-native-camera</a>) capturing user&#39;s face every 3-5 seconds and return the scores of 8 emotions:</p>
<div class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nt">"faceRectangle"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"left"</span><span class="p">:</span><span class="w"> </span><span class="mi">488</span><span class="p">,</span><span class="w">
      </span><span class="nt">"top"</span><span class="p">:</span><span class="w"> </span><span class="mi">263</span><span class="p">,</span><span class="w">
      </span><span class="nt">"width"</span><span class="p">:</span><span class="w"> </span><span class="mi">148</span><span class="p">,</span><span class="w">
      </span><span class="nt">"height"</span><span class="p">:</span><span class="w"> </span><span class="mi">148</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nt">"scores"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nt">"anger"</span><span class="p">:</span><span class="w"> </span><span class="mf">9.075572e-13</span><span class="p">,</span><span class="w">
      </span><span class="nt">"contempt"</span><span class="p">:</span><span class="w"> </span><span class="mf">7.048959e-9</span><span class="p">,</span><span class="w">
      </span><span class="nt">"disgust"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.02152783e-11</span><span class="p">,</span><span class="w">
      </span><span class="nt">"fear"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.778957e-14</span><span class="p">,</span><span class="w">
      </span><span class="nt">"happiness"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.9999999</span><span class="p">,</span><span class="w">
      </span><span class="nt">"neutral"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.31694478e-7</span><span class="p">,</span><span class="w">
      </span><span class="nt">"sadness"</span><span class="p">:</span><span class="w"> </span><span class="mf">6.04054263e-12</span><span class="p">,</span><span class="w">
      </span><span class="nt">"surprise"</span><span class="p">:</span><span class="w"> </span><span class="mf">3.92249462e-11</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="err">...</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div>
<p>We gather the data for 2 purposes:</p>

<ol>
<li>Granny changes her face in respond to the user&#39;s emotion.</li>
<li>The cumulated emotion distribution will be kept as the emotion report.</li>
</ol>

<p>Some problems encountered and solutions:</p>

<ol>
<li><p>When calling the API with <code>Content-Type</code> specifying <code>application/octet</code>, the required body format remains confusing (see <a href="http://stackoverflow.com/questions/37900554/microsoft-cognitive-services-uploading-image">here</a>). Eventually <a href="https://github.com/wkh237/react-native-fetch-blob">react-native-fetch-blob</a> saved my life. Here&#39;s the code snippet:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">RNFetchBlob</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">,</span> <span class="s1">'https://westus.api.cognitive.microsoft.com/emotion/v1.0/recognize'</span><span class="p">,</span> <span class="p">{</span>
  <span class="s1">'Ocp-Apim-Subscription-Key'</span><span class="p">:</span> <span class="p">[</span><span class="nx">your</span> <span class="nx">key</span><span class="p">],</span>
  <span class="s1">'Content-Type'</span> <span class="p">:</span> <span class="s1">'application/octet-stream'</span><span class="p">,</span>
<span class="p">},</span> <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
</code></pre></div></li>
<li><p>JUST.REMEMBER.TO.TURN.ON.YOUR.PHONE&#39;S.INTERNET.</p></li>
</ol>

<h2>User Speech End Detection</h2>

<p>Although we could simply make up a script and set timeout to continue to the next question for demo purpose, I strongly felt that it would not be amazing at all if everything were fake. Hence I came up with a detection method to detect when the user finishes speaking:</p>

<ol>
<li>Record background sound amplitude (averaging the first 10 second sampling data).</li>
<li>Retrieve the audio stream every 1 second, look for 3 consecutive seconds when the amplitude is less than the background (with some scaling).</li>
<li>If so, go to next question.</li>
</ol>

<p>The first problem is that we couldn&#39;t find a package that fit our need to retrieve the audio stream and the amplitudes. We decided to use <a href="https://github.com/jsierles/react-native-audio">react-native-audio</a> and start audio recording while saving the file to <code>/dev/null</code>. We can now register a listener for <code>onProgress</code>, which triggers the callback about every 1 second. The only field returned is <code>currentTime</code> though, so we modified the package itself to actually return <code>maxAmplitude</code> as well (see <a href="https://github.com/pyliaorachel/granny">github</a> for the line of code I added. Boom! It&#39;s working!</p>

<p>Another problem is that <a href="https://github.com/jsierles/react-native-audio/issues/111"><code>onProgress</code> seems not well supported on Android devices</a>. Use <code>DeviceEventEmitter</code> instead.</p>

<p>Lastly, remember to turn off the camera&#39;s capture sounds!</p>

<h4>Some Mysterious Problems (and Probably Solutions)</h4>

<ol>
<li>Some mysterious sound is coming out every 2-6 seconds when the user is talking, and I am not quite sure which of the packages causes this. This makes detecting whether the user has finished speaking or not troublesome because the noise produces quite a high amplitude. I doubt it to be caused by react-native-camera, but no evidence so far, and the problem remains unsolved.</li>
<li>According to <a href="https://github.com/facebook/react-native/issues/2481">this</a>, no dynamic strings are allowed in <code>Image</code> source. Require all the images first and alternate between them.</li>
<li>When I was importing and using color constants (in <code>src/utils/colors.js</code>), <code>Object.keys(colors)</code> also includes a <code>default</code> field. Don&#39;t know how to avoid this, so I simply discarded it.</li>
</ol>

<h4>Other Notes</h4>

<ol>
<li>After uninstalling packages, remember to unlink all references to them everywhere in your code!</li>
<li>Animations look slow in debugging mode, so don&#39;t panic, it is better than you thought.</li>
<li>Learning Android <strong>release build</strong> is awful! XCode requires only 1 press of button... See <a href="https://github.com/shyjal/reactnative-android-production">this tutorial</a> and try to install the release built app. If you have your debug app (or previous version of released app) on your phone, remember to uninstall it by running <code>adb uninstall [package name]</code> first (see <a href="http://stackoverflow.com/questions/26794862/failure-install-failed-update-incompatible-even-if-app-appears-to-not-be-insta">this</a>)! For example, my case would be <code>adb uninstall com.granny</code>.</li>
</ol>

		</div>

		<ul class="tag-list">
			

			<li class="tag">
				react-native
			</li>

			

			<li class="tag">
				azure
			</li>

			

			<li class="tag">
				emotion-api
			</li>

			
		</ul>

	</article>

	
		<div id="disqus_thread"></div>
<script>
	var disqus_config = function () {
	    this.page.url = "https://pyliaorachel.github.io";
	    this.page.identifier = "/project/app/2017/01/23/granny.html";
	};
	(function() {
	    var d = document, s = d.createElement('script');
	    s.src = '//pyliaorachel.disqus.com/embed.js';
	    s.setAttribute('data-timestamp', +new Date());
	    (d.head || d.body).appendChild(s);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	
</div>
	</div>
</main>
		<footer>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-4 footer-link">
				<a href="mailto:rachel5566kk@gmail.com">
					<span class="icon icon-email">
						<img src="/assets/svg/email-logo.svg" alt="Email Logo">
					</span>
					<span class="username">rachel5566kk@gmail.com</span>
				</a>
			</div>
			<div class="col-md-4 footer-link">
				<a href="https://github.com/pyliaorachel"  target="_blank">
					<span class="icon icon-github">
						<img src="/assets/svg/github-logo.svg" alt="GitHub Logo">
					</span>
					<span class="username">pyliaorachel</span>
				</a>
			</div>
			<div class="col-md-4 footer-link">
				<a href="https://tw.linkedin.com/in/peiyu-liao" target="_blank">
					<span class="icon icon-linkedin">
						<img src="/assets/svg/linkedin-logo.svg" alt="LinkedIn Logo">
					</span>
					<span class="username">Peiyu Liao</span>
				</a>
			</div>
		</div><!-- /.row -->
		<div class="row">
			<div class="footer-copy-right">
				<p>2017	&copy; Liao Peiyu</p>
			</div >
		</div><!-- /.row -->
	</div><!-- /.container-fluid -->
</footer>
		<script type="text/javascript" src="/js/main.js"></script>
		<script type="text/javascript" src="/js/home.js"></script>
		<script id="dsq-count-scr" src="//pyliaorachel.disqus.com/count.js" async></script>
	</body>
</html>